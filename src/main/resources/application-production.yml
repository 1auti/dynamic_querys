# ===============================================
# CONFIGURACIÓN PRODUCTION - Dynamic Querys
# ===============================================

# ========== MAPEO DE PROVINCIAS ==========
provincia:
  mapping:
    "Buenos Aires": pba
    "Avellaneda": mda
    "La Pampa": santa-rosa
    "Chaco": chaco
    "Entre Ríos": entre-rios
    "Formosa": formosa

# ============ CONFIGURACIÓN H2 (METADATA) ==============
spring:
  # === PROFILE ===
  config:
    activate:
      on-profile: production

  # === H2 DATABASE - RUTAS ABSOLUTAS PRODUCCIÓN ===
  datasource:
    jdbc-url: jdbc:h2:file:/opt/dynamic-querys/data/query_metadata;DB_CLOSE_ON_EXIT=FALSE;AUTO_SERVER=FALSE
    username: ${H2_USERNAME}
    password: ${H2_PASSWORD}
    driver-class-name: org.h2.Driver
    hikari:
      pool-name: "H2-QueryMetadata-Pool-Prod"
      maximum-pool-size: 20  # ⬆️ Aumentado para producción
      minimum-idle: 5
      connection-timeout: 10000
      idle-timeout: 600000
      max-lifetime: 1800000

  # === JPA/H2 ===
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false  #  Desactivado en producción
    properties:
      hibernate:
        jdbc:
          batch_size: 100
          fetch_size: 1000
          order_inserts: true
          order_updates: true
        dialect: org.hibernate.dialect.H2Dialect
        format_sql: false  #  Desactivado en producción
        use_sql_comments: false
    database-platform: org.hibernate.dialect.H2Dialect

  # === CONSOLA H2 - DESACTIVADA EN PRODUCCIÓN ===
  h2:
    console:
      enabled: false
      path: /h2-console
      settings:
        web-allow-others: false
        trace: false

  # === HTTP/MULTIPART ===
  servlet:
    multipart:
      max-file-size: 50MB
      max-request-size: 50MB

  # === JACKSON ===
  jackson:
    deserialization:
      fail-on-unknown-properties: false

# =============== POSTGRESQL - SOLO EN PRODUCCIÓN ===============
postgresql:
  datasources:
    # ========== BUENOS AIRES (PBA) ==========
    pba:
      jdbc-url: ${PBA_URL}
      username: ${PBA_USERNAME}
      password: ${PBA_PASSWORD}
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: "PostgreSQL-PBA-Pool"
        maximum-pool-size: 5  # Cantidad de conexiones para produccion
        minimum-idle: 2
        connection-timeout: 60000
        idle-timeout: 600000
        max-lifetime: 1800000
        keepalive-time: 300000
        leak-detection-threshold: 120000
        auto-commit: false
        register-mbeans: true
        connection-init-sql: >
          SET statement_timeout = '30min';
          SET work_mem = '64MB';
          SET max_parallel_workers_per_gather = 2;
          SET random_page_cost = 1.1;
          SET effective_cache_size = '4GB';
          SET idle_in_transaction_session_timeout = '10min';
        data-source-properties:
          tcpKeepAlive: true
          defaultRowFetchSize: 1000
          prepareThreshold: 0
          logUnclosedConnections: true
          logServerErrorDetail: true

    # ========== AVELLANEDA (MDA) ==========
    mda:
      jdbc-url: ${MDA_URL}
      username: ${MDA_USERNAME}
      password: ${MDA_PASSWORD}
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: "PostgreSQL-MDA-Pool"
        maximum-pool-size: 5
        minimum-idle: 2
        connection-timeout: 60000
        idle-timeout: 600000
        max-lifetime: 1800000
        keepalive-time: 300000
        leak-detection-threshold: 120000
        auto-commit: false
        register-mbeans: true
        connection-init-sql: >
          SET statement_timeout = '30min';
          SET work_mem = '64MB';
          SET max_parallel_workers_per_gather = 2;
          SET random_page_cost = 1.1;
          SET effective_cache_size = '4GB';
          SET idle_in_transaction_session_timeout = '10min';
        data-source-properties:
          tcpKeepAlive: true
          defaultRowFetchSize: 1000
          prepareThreshold: 0
          logUnclosedConnections: true
          logServerErrorDetail: true

    # ========== LA PAMPA (SANTA ROSA) ==========
    santa-rosa:
      jdbc-url: ${SANTA_ROSA_URL}
      username: ${SANTA_ROSA_USERNAME}
      password: ${SANTA_ROSA_PASSWORD}
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: "PostgreSQL-SantaRosa-Pool"
        maximum-pool-size: 5
        minimum-idle: 2
        connection-timeout: 60000
        idle-timeout: 600000
        max-lifetime: 1800000
        keepalive-time: 300000
        leak-detection-threshold: 120000
        auto-commit: false
        register-mbeans: true
        connection-init-sql: >
          SET statement_timeout = '30min';
          SET work_mem = '64MB';
          SET max_parallel_workers_per_gather = 2;
          SET random_page_cost = 1.1;
          SET effective_cache_size = '4GB';
          SET idle_in_transaction_session_timeout = '10min';
        data-source-properties:
          tcpKeepAlive: true
          defaultRowFetchSize: 1000
          prepareThreshold: 0
          logUnclosedConnections: true
          logServerErrorDetail: true

    # ========== CHACO ==========
    chaco:
      jdbc-url: ${CHACO_URL}
      username: ${CHACO_USERNAME}
      password: ${CHACO_PASSWORD}
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: "PostgreSQL-Chaco-Pool"
        maximum-pool-size: 5
        minimum-idle: 2
        connection-timeout: 60000
        idle-timeout: 600000
        max-lifetime: 1800000
        keepalive-time: 300000
        leak-detection-threshold: 120000
        auto-commit: false
        register-mbeans: true
        connection-init-sql: >
          SET statement_timeout = '30min';
          SET work_mem = '64MB';
          SET max_parallel_workers_per_gather = 2;
          SET random_page_cost = 1.1;
          SET effective_cache_size = '4GB';
          SET idle_in_transaction_session_timeout = '10min';
        data-source-properties:
          tcpKeepAlive: true
          defaultRowFetchSize: 1000
          prepareThreshold: 0
          logUnclosedConnections: true
          logServerErrorDetail: true

    # ========== ENTRE RÍOS ==========
    entre-rios:
      jdbc-url: ${ENTRE_RIOS_URL}
      username: ${ENTRE_RIOS_USERNAME}
      password: ${ENTRE_RIOS_PASSWORD}
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: "PostgreSQL-EntreRios-Pool"
        maximum-pool-size: 5
        minimum-idle: 2
        connection-timeout: 60000
        idle-timeout: 600000
        max-lifetime: 1800000
        keepalive-time: 300000
        leak-detection-threshold: 120000
        auto-commit: false
        register-mbeans: true
        connection-init-sql: >
          SET statement_timeout = '30min';
          SET work_mem = '64MB';
          SET max_parallel_workers_per_gather = 2;
          SET random_page_cost = 1.1;
          SET effective_cache_size = '4GB';
          SET idle_in_transaction_session_timeout = '10min';
        data-source-properties:
          tcpKeepAlive: true
          defaultRowFetchSize: 1000
          prepareThreshold: 0
          logUnclosedConnections: true
          logServerErrorDetail: true

    # ========== FORMOSA ==========
    formosa:
      jdbc-url: ${FORMOSA_URL}
      username: ${FORMOSA_USERNAME}
      password: ${FORMOSA_PASSWORD}
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: "PostgreSQL-Formosa-Pool"
        maximum-pool-size: 5
        minimum-idle: 2
        connection-timeout: 60000
        idle-timeout: 600000
        max-lifetime: 1800000
        keepalive-time: 300000
        leak-detection-threshold: 120000
        auto-commit: false
        register-mbeans: true
        connection-init-sql: >
          SET statement_timeout = '30min';
          SET work_mem = '64MB';
          SET max_parallel_workers_per_gather = 2;
          SET random_page_cost = 1.1;
          SET effective_cache_size = '4GB';
          SET idle_in_transaction_session_timeout = '10min';
        data-source-properties:
          tcpKeepAlive: true
          defaultRowFetchSize: 1000
          prepareThreshold: 0
          logUnclosedConnections: true
          logServerErrorDetail: true

# =============== SERVIDOR TOMCAT ===============
server:
  port: 8080
  tomcat:
    max-connections: 50
    threads:
      max: 20
      min-spare: 5
    connection-timeout: 30000
    max-http-post-size: 52428800
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: on_param  # Solo con parámetro ?trace=true

# =============== CONFIGURACIÓN APLICACIÓN - PRODUCCIÓN ===============
app:
  # === QUERY REGISTRY ===
  query-registry:
    auto-scan-enabled: true
    queries-path: classpath:querys/
    file-extensions: sql
    auto-analyze-on-startup: true
    scan-on-startup: true  # Escanea la aplicación al iniciar
    update-existing: true  # Permite actualizaciones de registros
    h2-file-path: /opt/dynamic-querys/data/query_metadata
    backup-enabled: true
    backup-interval-hours: 12
    upload-enabled: false  # 🔒 Desactivado por seguridad en producción
    upload-path: /opt/dynamic-querys/uploads/queries/
    max-file-size: 1MB
    allowed-extensions: sql

  # === QUERY ANALYZER ===
  query-analyzer:
    version: "1.0"
    enable-cache: false
    fallback-strategy: CONSOLIDACION_SIMPLE
    max-analysis-time-ms: 5000

  # === CONSOLIDACIÓN ===
  consolidacion:
    agregacion:
      umbral-error: 10
      limite-validacion: 10000
      limite-absoluto: 100000
    umbral:
      memoria: 500000
    cache:
      dir: /opt/dynamic-querys/data/temp/consolidacion
    default-strategy: "inteligente"
    max-grouping-fields: 5
    min-numeric-fields: 1

  # === LÍMITES ===
  limits:
    max-records-sync: 1000000000
    max-records-total: 100000
    max-records-display: 10000
    max-concurrent-queries: 10

  # === BATCH PROCESSING ===
  batch:
    size: 500  # Optimizado para producción
    memory-critical-threshold: 0.85
    parallel-threshold-per-province: 50000
    parallel-threshold-total: 300000
    massive-threshold-per-province: 200000
    max-parallel-provinces: 3
    thread-pool-size: 6

  # === ASYNC ===
  async:
    thread-pool-size: 10

# =============== LOGGING - PRODUCCIÓN ===============
logging:
  file:
    name: /opt/dynamic-querys/logs/application.log
    max-size: 50MB
    max-history: 30
    total-size-cap: 1GB
  level:
    # Niveles reducidos para producción
    org.transito_seguro: INFO
    org.transito_seguro.component.BatchProcessor: INFO
    org.transito_seguro.repository.impl.InfraccionesRepositoryImpl: INFO
    org.transito_seguro.component.ParametrosProcessor: INFO
    org.transito_seguro.component.StreamingFormatoConverter: INFO
    org.transito_seguro.service.InfraccionesService: INFO

    # Spring/Hibernate
    org.springframework.jdbc: WARN
    org.springframework.jdbc.core.JdbcTemplate: WARN
    org.springframework.jdbc.datasource: WARN
    org.hibernate.SQL: WARN
    org.hibernate.type: WARN

    # Otros
    com.zaxxer.hikari: INFO
    org.postgresql: WARN
    org.h2: WARN

  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# =============== ACTUATOR ===============
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,info,query-registry
        exclude: h2  # No exponer H2 en producción
  endpoint:
    health:
      show-details: when_authorized  # Solo con autenticación
    metrics:
      enabled: true
    query-registry:
      enabled: true
  metrics:
    export:
      simple:
        enabled: true